<%- include('partials/header') %>

    <div class="page-header d-flex justify-content-between align-items-center">
        <h4 class="page-title">Birthdays</h4>
        <div class="btn-group">
            <button onclick="exportCSV()" class="btn btn-success btn-round me-2">
                <i class="fa fa-download"></i> Export CSV
            </button>
            <button onclick="document.getElementById('csvFileInput').click()" class="btn btn-info btn-round me-2">
                <i class="fa fa-upload"></i> Import CSV
            </button>
            <button onclick="openModal('addBirthdayModal')" class="btn btn-primary btn-round">Add Birthday</button>
        </div>
    </div>

    <!-- Hidden file input for CSV import -->
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">


    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="birthdays-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Birth Date</th>
                                    <th>Status</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% birthdays.forEach(birthday=> { %>
                                    <tr>
                                        <td>
                                            <%= birthday.name %>
                                        </td>
                                        <td>
                                            <%= birthday.phone %>
                                        </td>
                                        <td>
                                            <%= dayjs(birthday.birthDate).format('DD MMMM YYYY') %>
                                        </td>
                                        <td>
                                            <span
                                                class="badge <%= birthday.isActive ? 'badge-success' : 'badge-danger' %>">
                                                <%= birthday.isActive ? 'Active' : 'Inactive' %>
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <button onclick="openEditModal('<%= JSON.stringify(birthday) %>')"
                                                class="btn btn-link btn-info btn-lg">
                                                <i class="fa fa-edit"></i>
                                            </button>
                                            <button onclick="deleteBirthday('<%= birthday._id %>')"
                                                class="btn btn-link btn-danger btn-lg">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Birthday Modal -->
    <div class="modal fade" id="addBirthdayModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="addBirthdayForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Birthday</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Name</label>
                            <input type="text" name="name" id="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="text" name="phone" id="phone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="birthDate">Birth Date</label>
                            <input type="date" name="birthDate" id="birthDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="message">Description</label>
                            <textarea name="message" id="message" rows="3" class="form-control"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Birthday Modal -->
    <div class="modal fade" id="editBirthdayModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="editBirthdayForm">
                    <input type="hidden" id="edit-id" name="id">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Birthday</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-name">Name</label>
                            <input type="text" name="name" id="edit-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-phone">Phone</label>
                            <input type="text" name="phone" id="edit-phone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-birthDate">Birth Date</label>
                            <input type="date" name="birthDate" id="edit-birthDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-message">Description</label>
                            <textarea name="message" id="edit-message" rows="3" class="form-control"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-isActive">Status</label>
                            <select id="edit-isActive" name="isActive" class="form-control">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function openModal(id) {
            const modalEl = document.getElementById(id);
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        function openEditModal(birthdayString) {
            const birthday = JSON.parse(birthdayString);
            document.getElementById('edit-id').value = birthday._id;
            document.getElementById('edit-name').value = birthday.name;
            document.getElementById('edit-phone').value = birthday.phone;
            document.getElementById('edit-birthDate').value = new Date(birthday.birthDate).toISOString().split('T')[0];
            document.getElementById('edit-message').value = birthday.message;
            document.getElementById('edit-isActive').value = birthday.isActive;
            openModal('editBirthdayModal');
        }

        document.getElementById('addBirthdayForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            await fetch('/api/birthdays', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            location.reload();
        });

        document.getElementById('editBirthdayForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const id = data.id;
            delete data.id;

            await fetch(`/api/birthdays/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            location.reload();
        });

        async function deleteBirthday(id) {
            if (confirm('Are you sure you want to delete this birthday?')) {
                await fetch(`/api/birthdays/${id}`, { method: 'DELETE' });
                location.reload();
            }
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof $ !== 'undefined' && $.fn.DataTable) {
                $('#birthdays-table').DataTable({
                    responsive: true,
                    pageLength: 10,
                    order: [],
                    language: { search: "_INPUT_", searchPlaceholder: "Search birthdays..." },
                    dom: '<"row mb-2"<"col-sm-6"l><"col-sm-6"f>>t<"row mt-2"<"col-sm-6"i><"col-sm-6"p>>'
                });
            }
        });
    </script>

    <script>
        // Export CSV function
        async function exportCSV() {
            try {
                const response = await fetch('/api/birthdays/export');
                if (!response.ok) {
                    throw new Error('Export failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'birthdays.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Show success notification
                showNotification('CSV exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Failed to export CSV', 'error');
            }
        }

        // Import CSV function
        async function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/birthdays/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Import failed');
                }

                // Show success message
                let message = result.message;
                if (result.errors && result.errors.length > 0) {
                    message += '\n\nErrors:\n' + result.errors.join('\n');
                }

                alert(message);
                location.reload();
            } catch (error) {
                console.error('Import error:', error);
                alert('Import failed: ' + error.message);
            }

            // Reset file input
            event.target.value = '';
        }

        // Notification helper function
        function showNotification(message, type) {
            // Check if there's a notification system in place
            if (typeof $.notify !== 'undefined') {
                $.notify({
                    message: message
                }, {
                    type: type,
                    placement: { from: 'top', align: 'right' }
                });
            } else {
                // Fallback to alert
                alert(message);
            }
        }
    </script>

    <%- include('partials/footer') %>