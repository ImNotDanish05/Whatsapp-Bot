<%- include('partials/header') %>

<div class="page-header d-flex justify-content-between align-items-center">
    <h4 class="page-title">Events</h4>
    <button onclick="openModal('addEventModal')" class="btn btn-primary btn-round">Add Event</button>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="events-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% (events || []).forEach(event => { %>
                                    <tr>
                                        <td><%= event.name %></td>
                                        <td>
                                            <% if (event.eventDate) { %>
                                                <%= dayjs(event.eventDate).format('DD MMM YYYY') %>
                                            <% } else { %>
                                                -
                                            <% } %>
                                        </td>
                                        <td>
                                            <span class="badge <%= event.isActive ? 'badge-success' : 'badge-danger' %>">
                                                <%= event.isActive ? 'Active' : 'Inactive' %>
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <button data-event='<%- JSON.stringify(event) %>' onclick="openEditModal(this.dataset.event)" class="btn btn-link btn-info btn-lg">
                                                <i class="fa fa-edit"></i>
                                            </button>
                                            <button onclick="deleteEvent('<%= event._id %>')" class="btn btn-link btn-danger btn-lg">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="addEventForm">
                <div class="modal-header">
                    <h5 class="modal-title">Add Event</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" name="name" id="name" class="form-control" placeholder="Contoh: Hari Kemerdekaan" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea name="description" id="description" rows="2" class="form-control" placeholder="Contoh: Peringatan Proklamasi Kemerdekaan"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label for="eventDate">Event Date</label>
                            <input type="date" name="eventDate" id="eventDate" class="form-control" placeholder="Contoh: 1945-08-17" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="recipients">Recipients</label>
                        <textarea name="recipients" id="recipients" rows="2" class="form-control" placeholder="Contoh: +628123..., +62898... (optional)"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="message">Message</label>
                        <textarea name="message" id="message-event" rows="3" class="form-control" placeholder="Contoh: Selamat %name%! Selamat memperingati %birthday%."></textarea>
                        <small class="form-text text-muted">Supported tokens: <strong>%name%</strong>, <strong>%age%</strong>, <strong>%birthday%</strong>, <strong>%born%</strong></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="editEventForm">
                <input type="hidden" id="edit-id" name="id">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Event</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-name">Name</label>
                        <input type="text" name="name" id="edit-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-description">Description</label>
                        <textarea name="description" id="edit-description" rows="2" class="form-control"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label for="edit-eventDate">Event Date</label>
                            <input type="date" name="eventDate" id="edit-eventDate" class="form-control" placeholder="Contoh: 1945-08-17" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-recipients">Recipients</label>
                        <textarea name="recipients" id="edit-recipients" rows="2" class="form-control" placeholder="Contoh: +628123..., +62898... (optional)"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-message">Message</label>
                        <textarea name="message" id="edit-message" rows="3" class="form-control"></textarea>
                        <small class="form-text text-muted">Supported tokens: <strong>%name%</strong>, <strong>%age%</strong>, <strong>%birthday%</strong>, <strong>%born%</strong></small>
                    </div>
                    <div class="form-group">
                        <label for="edit-isActive">Status</label>
                        <select id="edit-isActive" name="isActive" class="form-control">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/js/events.js"></script>

<script>
    function openModal(id) {
        const modalEl = document.getElementById(id);
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    function openEditModal(eventString) {
        const e = JSON.parse(eventString);
        document.getElementById('edit-id').value = e._id;
        document.getElementById('edit-name').value = e.name;
        document.getElementById('edit-description').value = e.description || '';
        // set eventDate input in YYYY-MM-DD format for HTML date inputs
        try {
            if (e.eventDate) {
                const d = new Date(e.eventDate);
                // format as local YYYY-MM-DD for HTML date input
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                document.getElementById('edit-eventDate').value = `${yyyy}-${mm}-${dd}`;
            } else {
                document.getElementById('edit-eventDate').value = '';
            }
        } catch (err) {
            document.getElementById('edit-eventDate').value = '';
        }
        document.getElementById('edit-recipients').value = (e.recipients || []).join(', ');
        document.getElementById('edit-message').value = e.message || '';
        document.getElementById('edit-isActive').value = e.isActive;
        openModal('editEventModal');
    }

    async function deleteEvent(id) {
        if (confirm('Are you sure you want to delete this event?')) {
            await fetch(`/api/events/${id}`, { method: 'DELETE' });
            location.reload();
        }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof $ !== 'undefined' && $.fn.DataTable) {
            $('#events-table').DataTable({
                responsive: true,
                pageLength: 10,
                order: [],
                language: { search: "_INPUT_", searchPlaceholder: "Search events..." },
                dom: '<"row mb-2"<"col-sm-6"l><"col-sm-6"f>>t<"row mt-2"<"col-sm-6"i><"col-sm-6"p>>'
            });
        }
    });
</script>

<%- include('partials/footer') %>
